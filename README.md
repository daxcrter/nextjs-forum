<h1 align="center">
  <img src="data:image/jpeg;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTQgNzkiPjxwYXRoIGQ9Ik0yNjEuOTE5IDAuMDMzMDcyMkgzMzAuNTQ3VjEyLjdIMzAzLjMyM1Y3OS4zMzlIMjg5LjcxVjEyLjdIMjYxLjkxOVYwLjAzMzA3MjJaIj48L3BhdGg+PHBhdGggZD0iTTE0OS4wNTIgMC4wMzMwNzIyVjEyLjdIOTQuMDQyMVYzMy4wNzcySDEzOC4yODFWNDUuNzQ0MUg5NC4wNDIxVjY2LjY3MjFIMTQ5LjA1MlY3OS4zMzlIODAuNDNWMTIuN0g4MC40MjQzVjAuMDMzMDcyMkgxNDkuMDUyWiI+PC9wYXRoPjxwYXRoIGQ9Ik0xODMuMzIgMC4wNjYxNDg2SDE2NS41MDZMMjI5LjMxMiA3OS4zNzIxSDI0Ny4xNzhMMjE1LjI3MSAzOS43NDY0TDI0Ny4xMjcgMC4xMjY2NTRMMjI5LjMxMiAwLjE1NDE4NEwyMDYuMzUyIDI4LjY2OTdMMTgzLjMyIDAuMDY2MTQ4NloiPjwvcGF0aD48cGF0aCBkPSJNMjAxLjYgNTYuNzE0OEwxOTIuNjc5IDQ1LjYyMjlMMTY1LjQ1NSA3OS40MzI2SDE4My4zMkwyMDEuNiA1Ni43MTQ4WiI+PC9wYXRoPjxwYXRoIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTgwLjkwNyA3OS4zMzlMMTcuMDE1MSAwSDBWNzkuMzA1OUgxMy42MTIxVjE2Ljk1MTZMNjMuODA2NyA3OS4zMzlIODAuOTA3WiIgZmlsbC1ydWxlPSJldmVub2RkIj48L3BhdGg+PHBhdGggZD0iTTMzMy42MDcgNzguODU0NkMzMzIuNjEgNzguODU0NiAzMzEuNzYyIDc4LjUwOTMgMzMxLjA1MiA3Ny44MTg2QzMzMC4zNDIgNzcuMTI3OSAzMjkuOTkxIDc2LjI5MTcgMzMwIDc1LjMwMTFDMzI5Ljk5MSA3NC4zMzc3IDMzMC4zNDIgNzMuNTEwNiAzMzEuMDUyIDcyLjgxOTlDMzMxLjc2MiA3Mi4xMjkyIDMzMi42MSA3MS43ODM4IDMzMy42MDcgNzEuNzgzOEMzMzQuNTY2IDcxLjc4MzggMzM1LjQwNSA3Mi4xMjkyIDMzNi4xMTUgNzIuODE5OUMzMzYuODM1IDczLjUxMDYgMzM3LjE5NCA3NC4zMzc3IDMzNy4yMDQgNzUuMzAxMUMzMzcuMTk0IDc1Ljk1NTQgMzM3LjAyOCA3Ni41NTUyIDMzNi42OTYgNzcuMDkxNEMzMzYuMzU1IDc3LjYzNjggMzM1LjkyMiA3OC4wNjQgMzM1LjM3NyA3OC4zNzNDMzM0Ljg0MiA3OC42OTExIDMzNC4yNTIgNzguODU0NiAzMzMuNjA3IDc4Ljg1NDZaIj48L3BhdGg+PHBhdGggZD0iTTM1Ni44NCA0NS40NDUzSDM2Mi44NzJWNjguNjg0NkMzNjIuODYzIDcwLjgyMDQgMzYyLjQwMSA3Mi42NDcyIDM2MS40OTggNzQuMTgzMkMzNjAuNTg1IDc1LjcxOTEgMzU5LjMyMSA3Ni44OTE0IDM1Ny42OTggNzcuNzE4NUMzNTYuMDg0IDc4LjUzNjQgMzU0LjE5MyA3OC45NTQ2IDM1Mi4wNDQgNzguOTU0NkMzNTAuMDc5IDc4Ljk1NDYgMzQ4LjMxOCA3OC42MDAxIDM0Ni43NSA3Ny45MDk0QzM0NS4xODIgNzcuMjE4NyAzNDMuOTM3IDc2LjE4MjYgMzQzLjAyNCA3NC44MTkzQzM0Mi4xMDEgNzMuNDU2IDM0MS42NDkgNzEuNzU2NSAzNDEuNjQ5IDY5LjcyMDdIMzQ3LjY5MUMzNDcuNyA3MC42MTE0IDM0Ny45MDMgNzEuMzgzOCAzNDguMjkgNzIuMDI5MUMzNDguNjc3IDcyLjY3NDQgMzQ5LjIxMiA3My4xNjUxIDM0OS44OTUgNzMuNTEwNUMzNTAuNTg2IDczLjg1NTkgMzUxLjM4IDc0LjAyODYgMzUyLjI3NCA3NC4wMjg2QzM1My4yNDMgNzQuMDI4NiAzNTQuMDczIDczLjgyODYgMzU0Ljc0NiA3My40MTk2QzM1NS40MTkgNzMuMDE5NyAzNTUuOTM2IDcyLjQxOTkgMzU2LjI5NiA3MS42MjAxQzM1Ni42NDYgNzAuODI5NSAzNTYuODMxIDY5Ljg0NzkgMzU2Ljg0IDY4LjY4NDZWNDUuNDQ1M1oiPjwvcGF0aD48cGF0aCBkPSJNMzg3LjY5MSA1NC41MzM4QzM4Ny41NDQgNTMuMTI1MSAzODYuODk4IDUyLjAyNTQgMzg1Ljc3MyA1MS4yNDM4QzM4NC42MzggNTAuNDUzMSAzODMuMTcyIDUwLjA2MjMgMzgxLjM3MyA1MC4wNjIzQzM4MC4xMSA1MC4wNjIzIDM3OS4wMjIgNTAuMjUzMiAzNzguMTE4IDUwLjYyNThDMzc3LjIxNCA1MS4wMDc1IDM3Ni41MTMgNTEuNTE2NCAzNzYuMDMzIDUyLjE2MTdDMzc1LjU1NCA1Mi44MDcgMzc1LjMxNCA1My41NDMyIDM3NS4yOTUgNTQuMzcwM0MzNzUuMjk1IDU1LjA2MSAzNzUuNDYxIDU1LjY2MDggMzc1Ljc4NCA1Ni4xNjA3QzM3Ni4xMDcgNTYuNjY5NiAzNzYuNTQgNTcuMDk2OCAzNzcuMTAzIDU3LjQ0MjJDMzc3LjY1NiA1Ny43OTY2IDM3OC4yNzQgNTguMDg3NCAzNzguOTQ4IDU4LjMyMzdDMzc5LjYzIDU4LjU2IDM4MC4zMTMgNTguNzYgMzgwLjk5NSA1OC45MjM2TDM4NC4xNCA1OS42OTYxQzM4NS40MDQgNTkuOTg2OSAzODYuNjMxIDYwLjM3NzggMzg3LjgwMiA2MC44Nzc2QzM4OC45NzMgNjEuMzY4NCAzOTAuMDM0IDYxLjk5NTUgMzkwLjk2NSA2Mi43NDk4QzM5MS44OTcgNjMuNTA0MiAzOTIuNjM1IDY0LjQxMyAzOTMuMTc5IDY1LjQ3NjRDMzkzLjcyMyA2Ni41Mzk3IDM5NCA2Ny43ODQ4IDM5NCA2OS4yMjA4QzM5NCA3MS4xNTY2IDM5My41MDIgNzIuODU2MiAzOTIuNDk2IDc0LjMyODVDMzkxLjQ5MSA3NS43OTE3IDM5MC4wNDMgNzYuOTM2OSAzODguMTQzIDc3Ljc2NEMzODYuMjUyIDc4LjU4MiAzODMuOTY1IDc5IDM4MS4yNzIgNzlDMzc4LjY3MSA3OSAzNzYuNDAyIDc4LjYwMDIgMzc0LjQ5MyA3Ny44MDA0QzM3Mi41NzUgNzcuMDA5NyAzNzEuMDggNzUuODQ2MyAzNzAuMDAxIDc0LjMxOTRDMzY4LjkyMiA3Mi43OTI2IDM2OC4zNDEgNzAuOTI5NCAzNjguMjU4IDY4LjczOTFIMzc0LjIzNUMzNzQuMzE4IDY5Ljg4NDIgMzc0LjY4NyA3MC44Mzg2IDM3NS4zMTQgNzEuNjExMUMzNzUuOTUgNzIuMzc0NSAzNzYuNzggNzIuOTM4IDM3Ny43OTUgNzMuMzE5N0MzNzguODE5IDczLjY5MjMgMzc5Ljk2MiA3My44ODMyIDM4MS4yMjYgNzMuODgzMkMzODIuNTQ1IDczLjg4MzIgMzgzLjcwNyA3My42ODMyIDM4NC43MTIgNzMuMjkyNEMzODUuNzA4IDcyLjkwMTYgMzg2LjQ5MiA3Mi4zNTY0IDM4Ny4wNTUgNzEuNjQ3NUMzODcuNjI3IDcwLjk0NzYgMzg3LjkxMyA3MC4xMjA2IDM4Ny45MjIgNjkuMTc1NEMzODcuOTEzIDY4LjMxMiAzODcuNjU0IDY3LjU5MzkgMzg3LjE1NiA2Ny4wMzA0QzM4Ni42NDkgNjYuNDY3IDM4NS45NDggNjUuOTk0NCAzODUuMDUzIDY1LjYxMjdDMzg0LjE1IDY1LjIzMSAzODMuMDk4IDY0Ljg4NTYgMzgxLjg5OSA2NC41ODU3TDM3OC4wODEgNjMuNjIyM0MzNzUuMzIzIDYyLjkyMjUgMzczLjEzNyA2MS44NTkyIDM3MS41NDEgNjAuNDMyM0MzNjkuOTM3IDU5LjAwNTQgMzY5LjE0MyA1Ny4xMTUgMzY5LjE0MyA1NC43NDI5QzM2OS4xNDMgNTIuNzk4IDM2OS42NzggNTEuMDg5NCAzNzAuNzU4IDQ5LjYyNjFDMzcxLjgyNyA0OC4xNjI5IDM3My4yOTQgNDcuMDI2OCAzNzUuMTQ4IDQ2LjIxNzlDMzc3LjAxMSA0NS40IDM3OS4xMTQgNDUgMzgxLjQ1NiA0NUMzODMuODM2IDQ1IDM4NS45MiA0NS40IDM4Ny43MTkgNDYuMjE3OUMzODkuNTE3IDQ3LjAyNjggMzkwLjkyOSA0OC4xNTM4IDM5MS45NTIgNDkuNTg5N0MzOTIuOTc2IDUxLjAyNTcgMzkzLjUxMSA1Mi42NzA3IDM5My41MzkgNTQuNTMzOEgzODcuNjkxWiI+PC9wYXRoPjwvc3ZnPg0K" alt="Next.js Logo" width="84">
  <br>
  Next.js Discord Forum
</h1>

<p align="center">The Next.js Discord server indexed in the web</p>

## Getting Started

This repo contains the code for both the Discord bot that index the posts and the front-end app

### Installing the dependencies

```sh
pnpm install
```

### Configuring the env vars

If you are developing locally, you need to create `.env` files in both the `apps/web` and `app/bot` folder. Refer to the table below for all the env vars in the project

#### Project: `apps/web`

| Name                   | Description                                                                                              | Required? |
| ---------------------- | -------------------------------------------------------------------------------------------------------- | --------- |
| `DATABASE_URL`         | The read-only connection string to connect to the DB, used to query the posts and messages               | ✔️        |
| `REVALIDATE_SECRET`    | The secret that allows remote revalidations to the app cache. This var should also be set in the bot app | ✔️        |
| `NEXT_PUBLIC_BASE_URL` | The URL where the app is hosted                                                                          | ❌        |

#### Project: `apps/bot`

| Name                     | Description                                                                                                             | Required? |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------- | --------- |
| `DISCORD_BOT_TOKEN`      | The token for the bot. If you don't have a bot yet, go to the bot project section for more details on how to create one | ✔️        |
| `DISCORD_CLIENT_ID`      | Client ID of the bot app                                                                                                | ✔️        |
| `DEV_GUILD_ID`           | The ID of the Discord server to register dev commands with `pnpm dev:register-commands`                                 | ❌        |
| `PUBLIC_PROFILE_ROLE_ID` | The ID of the role to make Discord profiles public in the database                                                      | ❌        |
| `HELPER_ROLE_ID`         | The ID of the role that allows for selecting answer on behalf of owner                                                  | ❌        |
| `MODERATOR_ROLE_ID`      | The ID of the role to set moderator status in the database (also can select answer)                                     | ❌        |
| `REGULAR_MEMBER_ROLE_ID` | The ID of the role to add to users when they reach the points milestone                                                 | ❌        |
| `INDEXABLE_CHANNEL_IDS`  | Comma-separated list of forum channels to index                                                                         | ✔️        |
| `MOD_LOG_CHANNEL_ID`     | The ID of the channel to log things for mods                                                                            | ❌        |
| `DATABASE_URL`           | The connection string to connect to the DB                                                                              | ✔️        |
| `REVALIDATE_SECRET`      | The same secret from the `web` project                                                                                  | ✔️        |
| `WEB_URL`                | The address of the web service, used to make the call to revalidate the cache                                           | ✔️        |

#### Project: `packages/db` (only necessary if you plan to run migrations)

| Name           | Description                                                                 | Required? |
| -------------- | --------------------------------------------------------------------------- | --------- |
| `DATABASE_URL` | The admin connection string to connect to the DB, used to modify the schema | ✔️        |

### Running the development projects

To run both the `web` and `bot` projects at the same time, use the following command:

```sh
pnpm dev
```

> **Note**: You don't need to run both projects always at the same time, they can work separately

## Creating your own bot instance

You will need your own bot to run the project locally, it is also recommended to create a new Discord server as a testing playground.

1. Go to https://discord.com/developers/applications and click on New Application
2. In the General Information page, copy the `APPLICATION ID`, this is the value of the `DISCORD_CLIENT_ID` env var
3. Go to the Bot page, click on Reset Token. Copy the new token and store it in the `DISCORD_BOT_TOKEN` env var. **DO NOT** share this token anywhere
4. In the "Privileged Gateway Intents" section, enable `SERVER MEMBERS INTENT` and `MESSAGE CONTENT INTENT`

To invite the bot to your own server, go to the OAuth2 > URL Generator page, select the `bot` scope and add the following permissions:

- Manage Roles
- Send Messages
- Send Messages in Threads
- Manage Message
- Manage Threads
- Embed Links
- Read Message History
- Add Reactions
- Use Slash Commands

Copy the Generated URL and open it in your browser

### Registering Discord commands

To use the context and slash commands you first need to register them in Discord. The easiest way to do that is by running this command:

```sh
pnpm dev:register-commands
```

Notice the `dev:` prefix in the command. Discord limits how many times you can register commands with their API, but by registering the command in a specific server you can do this as many times as you want. You need the `DEV_GUILD_ID` env var set to use this command

## Creating the database

This project uses PostgreSQL for the database, the easiest way to get it up and running is by using Docker. Start the database with this command:

```sh
docker compose up
```

And use this for the environment variable:

```sh
DATABASE_URL='postgresql://nextjsuser:nextjspassword@localhost:5432/nextjsforum'
```

If for some reason you want to start the database from scratch you can use the following command (this will erase all the data!):

```sh
docker compose down -v
```

### Running migrations

Once the database is running, add the previous `DATABASE_URL` variable to the `packages/db/.env` file and run this command:

```sh
pnpm migrate
```
